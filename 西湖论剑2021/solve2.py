N = 64

class lfsr():
    def __init__(self, init, mask, length):
        self.init = init
        self.mask = mask
        self.lengthmask = 2**length-1

    def next(self):
        nextdata = (self.init << 1) & self.lengthmask 
        i = self.init & self.mask & self.lengthmask 
        output = 0
        while i != 0:
            output ^= (i & 1)
            i = i >> 1
        nextdata ^= output
        self.init = nextdata
        return output


def backtrace(state, mask):
    mask = ((mask & 0x7FFFFFFFFFFFFFFF) << 1) + 1
    i = state & mask
    output = 0
    while i != 0:
        output ^= (i & 1)
        i = i >> 1
    state >>= 1
    return (output << 63) + state



output = "10001011010100011000100101001011100010110111001100001110000111011011100101101101000111101100010111100011000011111111010101111100101010101100010100000111011010011110111000100000101100101010110100111100011000101010101011011111011011000001101001011000010000011110001111001111011100110011111111101000111101001010000110001110111101001001101011101101001010001101010010110000000000001001101100101011110011010110011010110110011001001111001010100011110111100100010110111100110010000000010010011110001100000011000001110001000000010000100100101100000011100000011110101001011010011010100001101000010100100000011001011001000110000000000111011101000110010110111110010101110010001010001111111000011010000011001110111001000010011000000111010111100000100010011001111101110110100100011111000111000011111101010010110011111100010000100101011000001010101111101111001000011101111000111000101011010111100110001011011100101001010110110110110011100100111100110001101110010100010111100000110000010110100010001100011011001100100110101110010100011101110110010000010011100000011100000101010011011111110000100000010001010111011011111110100111100011100011110110010001011101111001011101010110111001001000111001001111001111110111111100001111100100110011111110110101000011010111110010001100000111100010011100011010000101010111010101101000011001110011000000110110110001101100110101110010010111011100110101000110000011001010100000110000000001110010001010001001101111100001111111011010010011100110010000111010001001111111110000010101110011010100100101101100111000010110100110010001010110111110011000111011101110100010000110110110011001011111011111000000000000001110000001000011000110111000000110100110110001111011111100010010011100101010000111000011111010000001010010011101010010110011000000001111110000000010111011000010001111000100110101110001000011111001101111111100011111011001001110000101001101110100111010011011101000110010000001001000001100110001110101100001000110100100010111101100010100110011111010011100100001101111010000110110101111111001111011100001101100000001101111100100"
mask1=17638491756192425134
mask2=14623996511862197922
ans=[]


# 这里没有回溯的过程，减少穷举时间
for i in range(1984):
    gadget = int(output[i:i+64], 2)
    l1=lfsr(gadget,mask1,64)
    cnt=0    

    for j in range(i+64, 2048):
        if l1.next()==int(output[j]):
            cnt+=1
            
    total=1984-i
    # 输出为lfsr1概率
    ans.append((i, cnt / total))

ans.sort(key=lambda x:x[1], reverse=True)

ans2=[]
for i, each in ans:
    if each > 0.85:
        ans2.append((i,each))
    else:
        break
# 比例高于0.85的
ans2.sort(key=lambda x:x[0])
print(ans2)
idx = ans2[0][0]

# 从661到6669都是来自lfsr1的

init1 = output[idx:idx+64]
init1 = int(init1, 2)

# 回溯状态
for _ in range(idx):
    init1 = backtrace(init1, mask1)
# 得到初始值
for _ in range(64):
    init1 = backtrace(init1, mask1)

print(init1)

# 作者: Suers
# 链接: https://team-su.github.io/passages/2021-11-20-XHLJ/
# 来源: team-su.github.io
# 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
